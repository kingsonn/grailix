"use client";

import { useState, useEffect } from "react";
import { useAccount } from "wagmi";
import { useUser } from "@/lib/useUser";
import WalletConnectButton from "@/components/WalletConnectButton";
import AppLayout from "@/components/AppLayout";
import Link from "next/link";

interface Prediction {
  id: number;
  prediction_text: string;
  asset: string;
  asset_type?: string;
  raw_text?: string;
  expiry_timestamp: string;
  betting_close?: string;
  direction?: string;
  reference_type?: string;
  sentiment_yes: number;
  sentiment_no: number;
}

export default function PredictClient() {
  const { address, isConnected } = useAccount();
  const { user, isLoading: userLoading, refetch } = useUser();
  const [predictions, setPredictions] = useState<Prediction[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showStakeModal, setShowStakeModal] = useState(false);
  const [selectedPrediction, setSelectedPrediction] = useState<Prediction | null>(null);
  const [selectedPosition, setSelectedPosition] = useState<"YES" | "NO" | "SKIP" | null>(null);
  const [stakeAmount, setStakeAmount] = useState(10);
  const [category, setCategory] = useState<"all" | "stock" | "crypto">("all");

  // Auto-refresh user data
  useEffect(() => {
    if (isConnected && address) {
      refetch();
    }
  }, [address, isConnected, refetch]);

  // Fetch multiple predictions
  const fetchPredictions = async () => {
    if (!user) return;

    setIsLoading(true);
    setError(null);

    try {
      // Fetch multiple predictions (we'll fetch 6 for a nice grid)
      const predictionPromises = [];
      for (let i = 0; i < 6; i++) {
        predictionPromises.push(
          fetch(`/api/predictions/next?user_wallet_address=${user.wallet_address}&asset_type=${category}`)
            .then(res => res.json())
        );
      }
      
      const results = await Promise.all(predictionPromises);
      const validPredictions = results
        .filter(data => data.success && data.data?.prediction)
        .map(data => data.data.prediction);
      
      // Remove duplicates by ID
      const uniquePredictions = Array.from(
        new Map(validPredictions.map(p => [p.id, p])).values()
      );
      
      setPredictions(uniquePredictions);
      
      if (uniquePredictions.length === 0) {
        setError("No predictions available");
      }
    } catch (err) {
      console.error("Error fetching predictions:", err);
      setError("Failed to load predictions");
    } finally {
      setIsLoading(false);
    }
  };

  // Load predictions on mount or category change
  useEffect(() => {
    if (user) {
      fetchPredictions();
    }
  }, [user, category]);

  // Helper function to check if betting is closed
  const isBettingClosed = (prediction: Prediction) => {
    if (!prediction.betting_close) return false;
    const now = new Date().getTime();
    const bettingCloseTime = new Date(prediction.betting_close).getTime();
    return now >= bettingCloseTime;
  };

  // Countdown timer for expiry
  useEffect(() => {
    if (!prediction?.expiry_timestamp) {
      setTimeLeft("");
      return;
    }

    const interval = setInterval(() => {
      const now = new Date().getTime();
      const expiry = new Date(prediction.expiry_timestamp).getTime();
      const diff = Math.max(expiry - now, 0);

      const hours = Math.floor(diff / 3600000);
      const minutes = Math.floor((diff % 3600000) / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);

      if (hours > 0) {
        setTimeLeft(`${hours}h ${minutes}m`);
      } else {
        setTimeLeft(`${minutes}:${seconds.toString().padStart(2, "0")}`);
      }

      if (diff <= 0) {
        clearInterval(interval);
        setTimeLeft("Expired");
        setTimeout(() => fetchNextPrediction(), 2000);
      }
    }, 1000);

    return () => clearInterval(interval);
  }, [prediction]);

  // Countdown timer for betting close
  useEffect(() => {
    if (!prediction?.betting_close) {
      setTimeToBettingClose("");
      setBettingClosed(false);
      return;
    }

    const interval = setInterval(() => {
      const now = new Date().getTime();
      const bettingCloseTime = new Date(prediction.betting_close!).getTime();
      const diff = Math.max(bettingCloseTime - now, 0);

      if (diff <= 0) {
        setBettingClosed(true);
        setTimeToBettingClose("Closed");
        clearInterval(interval);
      } else {
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        if (hours > 0) {
          setTimeToBettingClose(`${hours}h ${minutes}m`);
        } else {
          setTimeToBettingClose(`${minutes}:${seconds.toString().padStart(2, "0")}`);
        }
      }
    }, 1000);

    return () => clearInterval(interval);
  }, [prediction]);

  // Handle stake submission
  const handleStake = async () => {
    if (!user || !prediction || !selectedPosition) return;

    setIsLoading(true);
    setError(null);

    try {
      const response = await fetch("/api/predictions/stake", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          wallet_address: user.wallet_address,
          prediction_id: prediction.id,
          position: selectedPosition,
          stake_credits: selectedPosition === "SKIP" ? 0 : stakeAmount,
        }),
      });

      const data = await response.json();

      if (data.success) {
        setShowStakeModal(false);
        setSelectedPosition(null);
        fetchNextPrediction();
        refetch();
      } else {
        setError(data.error || "Failed to submit stake");
      }
    } catch (err) {
      console.error("Error staking:", err);
      setError("Failed to submit stake");
    } finally {
      setIsLoading(false);
    }
  };

  // Calculate sentiment percentages
  const totalVotes = prediction ? prediction.sentiment_yes + prediction.sentiment_no : 0;
  const yesPercent = totalVotes > 0 ? Math.round((prediction!.sentiment_yes / totalVotes) * 100) : 50;
  const noPercent = totalVotes > 0 ? Math.round((prediction!.sentiment_no / totalVotes) * 100) : 50;

  return (
    <AppLayout>
      <div className="max-w-4xl mx-auto px-4 sm:px-6 py-4">
        {/* Terminal Header with Back Button and Filters */}
        {isConnected && user && (
          <div className="bg-void-black border border-grail/30 rounded-lg overflow-hidden shadow-xl mb-4">
            {/* Terminal Title Bar */}
            <div className="bg-gradient-to-r from-void-graphite to-void-graphite/80 border-b border-grail/30 px-4 py-2 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Link
                  href="/"
                  className="flex items-center gap-2 text-gray-400 hover:text-grail-light transition-colors group"
                >
                  <svg className="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                  <span className="text-xs font-mono tracking-wider hidden sm:inline">BACK</span>
                </Link>
                <div className="w-px h-4 bg-grail/30"></div>
                <div className="flex items-center gap-2">
                  <div className="w-1.5 h-1.5 rounded-full bg-grail animate-pulse shadow-lg shadow-grail/50"></div>
                  <span className="text-gray-400 text-xs font-mono tracking-wider">PREDICTION_MARKET</span>
                </div>
              </div>
              <div className="flex items-center gap-2 bg-grail/10 px-2.5 py-1 rounded-full border border-grail/30">
                <div className="w-1.5 h-1.5 rounded-full bg-grail animate-pulse shadow-lg shadow-grail/50"></div>
                <span className="text-grail-light text-xs font-mono font-bold">ACTIVE</span>
              </div>
            </div>
            
            {/* Compact Filters */}
            <div className="p-4">
              <div className="flex items-center gap-2">
                <span className="text-gray-500 text-xs font-mono uppercase mr-2">Filter:</span>
                <div className="flex gap-2">
                  {[
                    { value: "all", label: "All", icon: "üåê" },
                    { value: "stock", label: "Stocks", icon: "üìà" },
                    { value: "crypto", label: "Crypto", icon: "‚Çø" },
                  ].map((cat) => (
                    <button
                      key={cat.value}
                      onClick={() => setCategory(cat.value as any)}
                      className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg font-mono text-xs font-bold transition-all ${
                        category === cat.value
                          ? "bg-gradient-to-r from-grail to-grail-light text-white shadow-lg shadow-grail/30 border border-grail/50"
                          : "bg-void-graphite text-gray-400 hover:text-white hover:bg-void-graphite/60 border border-grail/20"
                      }`}
                    >
                      <span className="text-sm">{cat.icon}</span>
                      <span className="hidden sm:inline">{cat.label}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Error Message */}
        {error && (
          <div className="bg-loss/10 border border-loss rounded-xl p-4 mb-6 text-loss">
            ‚ö†Ô∏è {error}
          </div>
        )}

        {/* Wallet Connection */}
        {!isConnected && (
          <div className="grail-glass rounded-2xl p-12 text-center">
            <div className="text-6xl mb-4">üîê</div>
            <h2 className="text-2xl font-bold mb-3">Connect to Trade</h2>
            <p className="text-gray-400 mb-6">
              Connect your wallet to access professional prediction markets
            </p>
            <WalletConnectButton />
          </div>
        )}

        {/* Loading State */}
        {isConnected && isLoading && !prediction && (
          <div className="grail-card rounded-2xl p-12 text-center">
            <div className="inline-block animate-spin rounded-full h-16 w-16 border-4 border-grail border-t-transparent mb-4"></div>
            <p className="text-grail-pale text-lg">Loading next prediction...</p>
          </div>
        )}

        {/* Prediction Card - Terminal Style */}
        {isConnected && user && prediction && !isLoading && (
          <div className="fade-in">
            {/* Desktop: Multi-grid view, Mobile/Tablet: Single card */}
            <div className="lg:grid lg:grid-cols-2 lg:gap-4">
              {/* Main Prediction Card */}
              <div className="bg-void-black border border-grail/30 rounded-lg overflow-hidden shadow-xl mb-4 lg:mb-0">
                {/* Terminal Title Bar */}
                <div className="bg-gradient-to-r from-void-graphite to-void-graphite/80 border-b border-grail/30 px-4 py-2 flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <div className="w-1.5 h-1.5 rounded-full bg-neon animate-pulse shadow-lg shadow-neon/50"></div>
                    <span className="text-gray-400 text-xs font-mono tracking-wider">PREDICTION_DATA</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="text-xs font-mono text-gray-500">ID: {prediction.id}</div>
                  </div>
                </div>

                {/* Asset Header */}
                <div className="p-4 border-b border-grail/20">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-grail/20 to-grail/5 border border-grail/30 flex items-center justify-center text-xl">
                        {prediction.asset_type === "crypto" ? "‚Çø" : "üìà"}
                      </div>
                      <div>
                        <h3 className="text-xl font-black font-mono text-white">{prediction.asset}</h3>
                        <p className="text-xs text-gray-500 uppercase tracking-wider font-mono">
                          {prediction.asset_type || "Market"}
                        </p>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="text-xs text-gray-500 mb-1 font-mono">RESOLVES_IN</div>
                      <div className="text-lg font-bold text-neon font-mono tabular-nums">{timeLeft}</div>
                    </div>
                  </div>
                </div>

                {/* Prediction Text */}
                <div className="p-4 border-b border-grail/20">
                  <div className="flex items-center gap-2 mb-2">
                    <div className="w-1 h-1 rounded-full bg-grail"></div>
                    <span className="text-xs font-mono text-gray-500 uppercase">Question</span>
                  </div>
                  <p className="text-base text-gray-200 leading-relaxed font-mono">
                    {prediction.prediction_text}
                  </p>
                </div>

                {/* Raw Text */}
                {prediction.raw_text && (
                  <div className="p-4 border-b border-grail/20 bg-void-graphite/30">
                    <div className="flex items-center gap-2 mb-2">
                      <div className="w-1 h-1 rounded-full bg-auric"></div>
                      <span className="text-xs font-mono text-gray-500 uppercase">Raw_Data</span>
                    </div>
                    <p className="text-sm text-gray-400 leading-relaxed font-mono">
                      {prediction.raw_text}
                    </p>
                  </div>
                )}

                {/* Betting Close Timer */}
                {prediction.betting_close && (
                  <div className="p-4 border-b border-grail/20">
                    <div className={`flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-mono font-bold ${
                      bettingClosed ? 'bg-loss/20 text-loss border border-loss/30' : 'bg-neon/20 text-neon border border-neon/30'
                    }`}>
                      <div className={`w-1.5 h-1.5 rounded-full ${bettingClosed ? 'bg-loss' : 'bg-neon animate-pulse'}`}></div>
                      <span>
                        {bettingClosed ? "BETTING_CLOSED" : `CLOSES_IN: ${timeToBettingClose}`}
                      </span>
                    </div>
                  </div>
                )}

                {/* User Balance */}
                <div className="p-4 bg-void-graphite/50">
                  <div className="flex items-center justify-between">
                    <span className="text-xs font-mono text-gray-500 uppercase">Your_Balance</span>
                    <div className="flex items-center gap-2">
                      <span className="text-auric font-bold text-lg font-mono tabular-nums">{user.real_credits_balance}</span>
                      <span className="text-xs font-mono text-gray-500">USDC</span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Action Panel */}
              <div className="bg-void-black border border-grail/30 rounded-lg overflow-hidden shadow-xl">
                {/* Terminal Title Bar */}
                <div className="bg-gradient-to-r from-void-graphite to-void-graphite/80 border-b border-grail/30 px-4 py-2 flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <div className="w-1.5 h-1.5 rounded-full bg-profit animate-pulse shadow-lg shadow-profit/50"></div>
                    <span className="text-gray-400 text-xs font-mono tracking-wider">ACTION_PANEL</span>
                  </div>
                </div>

                {/* Market Sentiment */}
                <div className="p-4 border-b border-grail/20">
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-grail"></div>
                      <span className="text-xs font-mono text-gray-500 uppercase">Market_Sentiment</span>
                    </div>
                    <span className="text-xs text-gray-500 font-mono">{totalVotes} votes</span>
                  </div>
                  
                  {/* Sentiment Bar */}
                  <div className="relative h-2 bg-void-black rounded-full overflow-hidden mb-3 border border-grail/20">
                    <div
                      className="absolute left-0 top-0 h-full bg-profit transition-all duration-500"
                      style={{ width: `${yesPercent}%` }}
                    />
                    <div
                      className="absolute right-0 top-0 h-full bg-loss transition-all duration-500"
                      style={{ width: `${noPercent}%` }}
                    />
                  </div>

                  {/* Percentages */}
                  <div className="flex justify-between text-xs font-mono font-bold">
                    <span className="profit-text">{yesPercent}% YES</span>
                    <span className="loss-text">{noPercent}% NO</span>
                  </div>
                </div>

                {/* Action Buttons */}
                <div className="p-4">
                  <div className="grid grid-cols-3 gap-3">
                    <button
                      onClick={() => {
                        setSelectedPosition("YES");
                        setShowStakeModal(true);
                      }}
                      disabled={bettingClosed || isLoading}
                      className="bg-gradient-to-br from-profit to-profit/80 hover:from-profit/90 hover:to-profit/70 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-6 rounded-lg transition-all hover:scale-105 border border-profit/50 shadow-lg shadow-profit/20 font-mono"
                    >
                      <div className="text-2xl mb-1">‚úì</div>
                      <div className="text-sm">YES</div>
                    </button>
                    
                    <button
                      onClick={() => {
                        setSelectedPosition("SKIP");
                        handleStake();
                      }}
                      disabled={isLoading}
                      className="bg-void-graphite hover:bg-void-graphite/60 disabled:opacity-50 disabled:cursor-not-allowed text-gray-400 hover:text-white font-bold py-6 rounded-lg transition-all border border-grail/20 font-mono"
                    >
                      <div className="text-2xl mb-1">‚Üí</div>
                      <div className="text-sm">SKIP</div>
                    </button>
                    
                    <button
                      onClick={() => {
                        setSelectedPosition("NO");
                        setShowStakeModal(true);
                      }}
                      disabled={bettingClosed || isLoading}
                      className="bg-gradient-to-br from-loss to-loss/80 hover:from-loss/90 hover:to-loss/70 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-6 rounded-lg transition-all hover:scale-105 border border-loss/50 shadow-lg shadow-loss/20 font-mono"
                    >
                      <div className="text-2xl mb-1">‚úó</div>
                      <div className="text-sm">NO</div>
                    </button>
                  </div>
                </div>

                {/* Instructions */}
                <div className="p-4 bg-void-graphite/30 border-t border-grail/20">
                  <div className="space-y-2 text-xs font-mono text-gray-500">
                    <div className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-profit"></div>
                      <span>YES: Predict outcome will occur</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-loss"></div>
                      <span>NO: Predict outcome won't occur</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-gray-500"></div>
                      <span>SKIP: Pass to next prediction</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Stake Modal */}
        {showStakeModal && selectedPosition && selectedPosition !== "SKIP" && (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-6">
            <div className="grail-glass rounded-2xl p-8 max-w-md w-full">
              <h3 className="text-2xl font-bold mb-6 text-center">
                Stake on <span className={selectedPosition === "YES" ? "profit-text" : "loss-text"}>{selectedPosition}</span>
              </h3>

              <div className="mb-6">
                <label className="block text-sm text-gray-400 mb-2">Stake Amount</label>
                <input
                  type="number"
                  min="1"
                  max={user?.real_credits_balance || 0}
                  value={stakeAmount}
                  onChange={(e) => setStakeAmount(Number(e.target.value))}
                  className="w-full bg-void-graphite border border-grail/30 rounded-xl px-4 py-3 text-white text-lg font-bold focus:outline-none focus:border-grail"
                />
                <div className="flex justify-between mt-2 text-xs">
                  <span className="text-gray-500">Min: 1</span>
                  <span className="text-gray-400">Available: <span className="text-auric font-bold">{user?.real_credits_balance}</span></span>
                </div>
              </div>

              {/* Quick Amount Buttons */}
              <div className="grid grid-cols-4 gap-2 mb-6">
                {[10, 25, 50, 100].map((amount) => (
                  <button
                    key={amount}
                    onClick={() => setStakeAmount(amount)}
                    disabled={amount > (user?.real_credits_balance || 0)}
                    className="bg-void-graphite hover:bg-grail/20 disabled:opacity-30 disabled:cursor-not-allowed text-white py-2 rounded-lg text-sm font-bold transition-all"
                  >
                    {amount}
                  </button>
                ))}
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowStakeModal(false);
                    setSelectedPosition(null);
                  }}
                  className="flex-1 bg-void-graphite hover:bg-void-graphite/80 text-white font-bold py-4 rounded-xl transition-all"
                >
                  Cancel
                </button>
                <button
                  onClick={handleStake}
                  disabled={isLoading || stakeAmount < 1 || stakeAmount > (user?.real_credits_balance || 0)}
                  className={`
                    flex-1 font-bold py-4 rounded-xl transition-all
                    ${selectedPosition === "YES" ? "bg-profit hover:bg-profit/80" : "bg-loss hover:bg-loss/80"}
                    text-white disabled:opacity-50 disabled:cursor-not-allowed
                  `}
                >
                  {isLoading ? "Confirming..." : `Confirm ${selectedPosition}`}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </AppLayout>
  );
}
